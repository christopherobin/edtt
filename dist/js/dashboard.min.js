'use strict';angular.module("Dashboard",["ui.bootstrap","ui.router","ngCookies","angucomplete-alt"]);
angular.module("Dashboard").config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/"),t.state("index",{url:"/",templateUrl:"dashboard.html"}).state("tables",{url:"/tables",templateUrl:"tables.html"}).state("trades",{url:"/trades",templateUrl:"trades.html",controller:"TradeCtrl"}).state("systems",{url:"/systems",templateUrl:"systems.html",controller:"SystemsCtrl"})}]);
function AlertsCtrl(e){e.alerts=[{type:"success",msg:"Thanks for visiting! Feel free to create pull requests to improve the dashboard!"},{type:"danger",msg:"Found a bug? Create an issue with as many details as you can."}],e.addAlert=function(){e.alerts.push({msg:"Another alert!"})},e.closeAlert=function(t){e.alerts.splice(t,1)}}angular.module("Dashboard").controller("AlertsCtrl",["$scope",AlertsCtrl]);
function CreateStationCtrl(t,n){t.ok=function(){n.close(t.station)},t.cancel=function(){n.dismiss("cancel")}}angular.module("Dashboard").controller("CreateStationCtrl",["$scope","$modalInstance","Systems",CreateStationCtrl]);
function CreateSystemCtrl(e,n){e.economies=["None","Extraction","Agriculture","Industrial","Service","High-Tech","Refinery","Military","Terraforming","Tourism"],e.allegiances=["None","Empire","Independant","Federation","Alliance"],e.system={economy:e.economies[0],allegiance:e.allegiances[0]},e.ok=function(){n.close(e.system)},e.cancel=function(){n.dismiss("cancel")}}angular.module("Dashboard").controller("CreateSystemCtrl",["$scope","$modalInstance","Systems",CreateSystemCtrl]);
function MasterCtrl(t,e){var o=992;t.getWidth=function(){return window.innerWidth},t.$watch(t.getWidth,function(g){t.toggle=g>=o?angular.isDefined(e.get("toggle"))&&0==e.get("toggle")?!1:!0:!1}),t.toggleSidebar=function(o){t.toggle=!t.toggle,e.put("toggle",t.toggle),o.preventDefault()},window.onresize=function(){t.$apply()}}angular.module("Dashboard").controller("MasterCtrl",["$scope","$cookieStore",MasterCtrl]);
function SystemsCtrl(t,e,n,a){t.activeSystem=null,t.activeStation=null,t.systems=null,t.stations=null,t.station=null,t.market=null,t.galactic=null,n.list(function(e){t.systems=e}),a.list(function(e){t.galactic=e}),t.$watch("systems",function(e){e&&!t.activeSystem&&e.length>0&&(t.activeSystem=e[0])}),t.$watch("activeSystem",function(e,a){if(e!==a){if(!e)return void(t.stations=[]);n.system(e.name,function(e){t.stations=e.stations})}}),t.$watch("stations",function(e){t.activeStation=e&&e.length>0?e[0]:null}),t.$watch("activeStation",function(e,a){e!==a&&(e?n.station(t.activeSystem.name,e,function(e){t.station=e,t.market=e.market}):(t.station=null,t.market={}))}),t.$watch("station.services",function(e,a){"undefined"!=typeof e&&"undefined"!=typeof a&&n.setServices(t.activeSystem.name,t.activeStation,e,function(){})},!0),t.$on("editable",function(e,a,i){var c={};c[i.toLowerCase()]=parseInt(a[i],10),n.setEntry(t.activeSystem.name,t.activeStation,a.Name,c,function(){})}),t.compare=function(e,n){return{sell:n.Sell?n.Sell-t.galactic[e][n.Name].galactic_avg:0,buy:n.Buy?n.Buy-t.galactic[e][n.Name].galactic_avg:0}},t.selectSystem=function(e){t.activeSystem=e,t.activeStation=null},t.selectStation=function(e,n){t.activeStation=n,e.preventDefault()},t.createSystem=function(a){var i=e.open({templateUrl:"createSystem.html",controller:"CreateSystemCtrl"});i.result.then(function(e){n.createSystem(e,function(){n.list(function(e){t.systems=e})})},function(){}),a.preventDefault()},t.createStation=function(a){var i=e.open({templateUrl:"createStation.html",controller:"CreateStationCtrl"});i.result.then(function(e){n.createStation(t.activeSystem.name,e,function(){n.system(t.activeSystem.name,function(e){t.stations=e.stations})})},function(){}),a.preventDefault()}}angular.module("Dashboard").controller("SystemsCtrl",["$scope","$modal","Systems","Market",SystemsCtrl]);
function TradeCtrl(e,t,a){e.systems=null,e.market=null,e.goods=null,a.list(function(t){e.market=t;var a=[];for(var r in t)for(var n in t[r])a.push(t[r][n]);e.goods=a}),t.list(function(t){e.systems=t}),e.swapTrades=function(){var t=e.tradeFrom;e.tradeTo?e.$broadcast("angucomplete-alt:selectResult","tradeFrom",e.tradeTo):(e.$broadcast("angucomplete-alt:clearInput","tradeFrom"),e.tradeFrom=null),t?e.$broadcast("angucomplete-alt:selectResult","tradeTo",t):(e.$broadcast("angucomplete-alt:clearInput","tradeTo"),e.tradeTo=null)},e.findTrades=function(t){a.compare(e.tradeFrom.title,e.tradeTo?e.tradeTo.title:"ANY",{range:e.range},function(t){t.forEach(function(t){t.trades.forEach(function(t){if(e.cargoSize){var a=Math.min(e.cargoSize,Math.floor(e.funds/t.Buy));t.RevenueTotal=a*t.Revenue,t.UnitsTraded=a}}),t.trades.sort(function(e,t){return e.RevenueTotal?t.RevenueTotal-e.RevenueTotal:t.Revenue-e.Revenue})}),t.sort(function(e,t){return e.distance-t.distance}),e.routes=t}),t.preventDefault()},e.findGood=function(t){a.findGood(e.find.good.title,e.find.from.title,e.find.range,function(t){e.found=t}),t.preventDefault()}}angular.module("Dashboard").controller("TradeCtrl",["$scope","Systems","Market",TradeCtrl]);
function editable(e){var a={restrict:"A",scope:{category:"=category",entry:"=entry",compare:"=compare"},link:function(a,t,r){function n(){a.extra=null,"Sell"===l&&a.compareValue&&a.compareValue.sell&&(a.extra=a.compareValue.sell,a.cls=a.extra>0?"good":"bad"),"Buy"===l&&a.compareValue&&a.compareValue.buy&&(a.extra=a.compareValue.buy,a.cls=a.extra>0?"bad":"good"),t.html('{{value}} <span class="{{cls}}" ng-show="extra">({{extra}})</span>'),e(t.contents())(a)}var c=!1,l=r.editable;n(),t.on("click",function(){function e(e){var a=null;switch(e){case 0:a=t.prev("td[editable]");break;case 2:a=t.next("td[editable]");break;case 1:a=t.parent().prevAll("tr.entry").first().find('td[editable="'+l+'"]');break;case 3:a=t.parent().nextAll("tr.entry").first().find('td[editable="'+l+'"]')}a&&a.click()}if(!c){c=!0,t.html('<input type="text" class="form-control input-sm">');var r=t.find("input");r.on("focus",function(){setTimeout(function(){r.select()},0)}),r.val(a.entry[l]),r.focus(),r.on("keydown",function(t){switch(t.keyCode){case 13:case 37:case 38:case 39:case 40:c=!1,a.entry[l]=parseInt(r.val(),10),n(),a.$emit("editable",a.entry,l),t.keyCode>=37&&t.keyCode<=40&&e(t.keyCode-37);break;case 27:c=!1,n()}})}}),a.$watch("entry."+l,function(e){c=!1,a.value=numeral(e).format("0,0 CR"),a.compareValue=a.compare(a.category,a.entry),n()})}};return a}angular.module("Dashboard").directive("editable",["$compile",editable]);
function rdLoading(){var d={restrict:"AE",template:'<div class="loading"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'};return d}angular.module("Dashboard").directive("rdLoading",rdLoading);
function rdWidgetBody(){var d={requires:"^rdWidget",scope:{loading:"@?",classes:"@?"},transclude:!0,template:'<div class="widget-body" ng-class="classes"><rd-loading ng-show="loading"></rd-loading><div ng-hide="loading" class="widget-content" ng-transclude></div></div>',restrict:"E"};return d}angular.module("Dashboard").directive("rdWidgetBody",rdWidgetBody);
function rdWidgetTitle(){var e={requires:"^rdWidget",scope:{title:"@",icon:"@"},transclude:!0,template:'<div class="widget-header"> <i class="fa" ng-class="icon"></i> {{title}} <div class="pull-right" ng-transclude></div></div>',restrict:"E"};return e}angular.module("Dashboard").directive("rdWidgetHeader",rdWidgetTitle);
function rdWidget(){var d={transclude:!0,template:'<div class="widget" ng-transclude></div>',restrict:"EA"};return d}angular.module("Dashboard").directive("rdWidget",rdWidget);
function MarketService(e){return{list:function(o,n){n=n||Function(),e.get("/api/market").success(o).error(n)},compare:function(o,n,r,t,c){c=c||Function(),e.post("/api/market/"+encodeURIComponent(o)+"/"+(encodeURIComponent(n)||"ANY"),r).success(t).error(c)},findGood:function(o,n,r,t,c){c=c||Function(),e.post("/api/market/"+encodeURIComponent(o),{range:r,from:n}).success(t).error(c)}}}angular.module("Dashboard").factory("Market",["$http",MarketService]);
function SystemsService(e){return{list:function(n,t){t=t||Function(),e.get("/api/systems").success(function(e){e.sort(function(e,n){return e.name.localeCompare(n.name)}),n(e)}).error(t)},system:function(n,t,o){o=o||Function(),e.get("/api/systems/"+encodeURIComponent(n)).success(function(e){e.stations=e.stations||[],e.stations.sort(function(e,n){return e.localeCompare(n)}),t(e)}).error(o)},station:function(n,t,o,s){s=s||Function(),e.get("/api/systems/"+encodeURIComponent(n)+"/"+encodeURIComponent(t)).success(o).error(s)},setEntry:function(n,t,o,s,c,r){r=r||Function(),e.post("/api/systems/"+encodeURIComponent(n)+"/"+encodeURIComponent(t)+"/market/"+encodeURIComponent(o),s).success(c).error(r)},setServices:function(n,t,o,s,c){c=c||Function(),e.post("/api/systems/"+encodeURIComponent(n)+"/"+encodeURIComponent(t)+"/services",o).success(s).error(c)},createSystem:function(n,t,o){o=o||Function(),e.post("/api/systems",n).success(t).error(o)},createStation:function(n,t,o,s){s=s||Function(),e.post("/api/systems/"+encodeURIComponent(n),t).success(o).error(s)}}}angular.module("Dashboard").factory("Systems",["$http",SystemsService]);